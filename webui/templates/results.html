<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="{{url_for('static', filename='sample.css') }}">
  </head>
  <body>
    <h1><span id="so_many"></span> bounding boxes</h1>
    <div id="map">
      <img id="map_background" src="data:image/jpg;base64, {{image}}">
      <svg id="map_bboxes"
           width="{{width}}" height="{{height}}">
    </div>

    <script>
      const svgns = 'http://www.w3.org/2000/svg';
      var image = "{{image|safe}}";
      var bboxes = {{bboxes|safe}};
      var probs = {{probs|safe}};
      var width = {{width|safe}};
      var height = {{height|safe}};

      // Place the original image in the DOM
      /*
      document.querySelector('img#map_background').setAttribute(
          'src', 'data:image/jpg;base64, ' + image
      );
      */

      // Place the bounding boxes into an existing SVG element.
      container = document.querySelector('#map');
      var s = document.querySelector('svg#map_bboxes');
      // s.setAttributeNS(null, 'width', width);
      // s.setAttributeNS(null, 'height', height);

      // Create a mask of probable bboxes.
      var mask = probs.map(p => p > 0.6);
      bboxes_probable = bboxes.filter((item, i) => mask[i]);
      console.log(bboxes_probable);
      document.querySelector("#so_many").innerText = bboxes_probable.length;

      // And add them.
      // TODO: Would benefit from object with attribute names
      var rects = bboxes_probable.map(bb => {
          e = document.createElementNS(svgns, 'rect');
          e.setAttributeNS(null, 'x', bb[0]);
          e.setAttributeNS(null, 'y', bb[1]);
          e.setAttributeNS(null, 'width', bb[2] - bb[0]);
          e.setAttributeNS(null, 'height', bb[3] - bb[1]);
          return e;
      });

      rects.forEach(rect => s.appendChild(rect));

      // Scale down the container which has both the original and the
      // bounding boxes in it.
      var scale = window.innerWidth / (width * 2);
      var m = document.querySelector('#map');
      m.style.transform = "scale(" + scale + ")";

    </script>
  </body>
</html>
